// Includes
#include <Arduino.h>
#include <Streaming.h>
#include <SoftwareSerial.h>
#include <WiFlySerial.h>
#include <PString.h>
#include "Credentials.h"
#include "Device_Constants.h"
#include "MemoryFree.h"

// Precompiler definitions
#define DEBUG_ON 1
#define RX_PIN 2
#define TX_PIN 3
#define QUERY_STRING_BUFFER_SIZE 100
#define REQUEST_BUFFER_SIZE 80
#define HEADER_BUFFER_SIZE 120
#define BODY_BUFFER_SIZE 180

// Statics
WiFlySerial WiFly(RX_PIN, TX_PIN);
char requestBuffer[REQUEST_BUFFER_SIZE];
char headerBuffer[HEADER_BUFFER_SIZE];
char bodyBuffer[BODY_BUFFER_SIZE];

void freeRequestStrings(char* queryString, char* header, char* body) {
  free(queryString);
  free(header);
  free(body);
  queryString = NULL;
  header = NULL;
  body = NULL;
}

void setup() {
  // begin processes
  Serial.begin(9600);
  Serial << "Attempting to begin WiFly" << endl;
  WiFly.begin();
  
  #if DEBUG_ON
  Serial << "Debug On" << endl;
  WiFly.setDebugChannel( (Print*) &Serial);
  #endif
  
  // should be configured through wired network config interface
  WiFly.setAuthMode(WIFLY_AUTH_WPA2_PSK);
  WiFly.setDHCPMode(WIFLY_DHCP_ON);
  WiFly.setJoinMode(WIFLY_JOIN_AUTO);
  WiFly.setSSID(ssid);
  WiFly.setPassphrase(passphrase);
  
  Serial << "Attempting to connect to " << ssid << endl;
  if (WiFly.join()) {
    Serial << "Connected to " << ssid << endl;
  } else {
    Serial << "Failed to connect to " << ssid << endl;
    
    // halt execution, requires restart
    while (1) {}
  }
  
  Serial << "Waiting for network configuration..." << endl;
  delay (3000);
  
  Serial << "IP Address " << WiFly.getIP(requestBuffer, REQUEST_BUFFER_SIZE) << endl;
}

void loop() {
  #if DEBUG_ON
  int freeMemoryStart = freeMemory();
  #endif
  
  char* queryString = (char*) malloc(QUERY_STRING_BUFFER_SIZE);
  char* header = (char*) malloc(HEADER_BUFFER_SIZE);
  char* body = (char*) malloc(BODY_BUFFER_SIZE);
  
  // always null check mallocs in case out of heap space
  if (queryString == NULL || header == NULL || body == NULL) {
    Serial << "Heap Overflow Error" << endl;
    freeRequestStrings(queryString, header, body);
    
    // halt execution
    while (1) {}
  }
  
  // using PString library to be able to print to strings from memory (easier to implement)
  PString queryStringStr(queryString, QUERY_STRING_BUFFER_SIZE);
  PString headerStr(header, HEADER_BUFFER_SIZE);
  PString bodyStr(body, BODY_BUFFER_SIZE);
  
  // fill memory allocated to request strings
  queryStringStr << baseEndpoint << deviceId << closeEndpoint;
  
  // GET request
  if (WiFly.openConnection(queryStringStr)) {
    Serial << "Connection opened to server" << endl;
    
    // timeout
    delay(5000);
    
    WiFly.closeConnection();
  } else {
    Serial << "Failed to send HTTP request" << endl;
  }
  
  // free allocated memory, clear pointers to freed memory
  freeRequestStrings(queryString, header, body);
  
  #if DEBUG_ON
  int freeMemoryFinish = freeMemory();
  if (freeMemoryStart != freeMemoryFinish) {
     Serial << "Memory leak detected: " << endl
            << "Free memory at start: " << freeMemoryStart << endl
            << "Free memory at finish: " << freeMemoryFinish << endl; 
  }
  #endif
  
  delay(5000);
}
